#!/bin/sh -efu

. ../modules/test_lib.sh

# try to stop the server
./dev_server --stop --pidfile pid.tmp &>/dev/null ||:

assert_cmd "wget localhost:8082/b/ask/text -nv -S"\
  "failed: Connection refused." 4

rm -f log.txt

# run the server
assert_cmd "./dev_server --pidfile pid.tmp --config test_data/n2.txt --logfile log.txt --daemon" "" 0

a=$(wget localhost:8082/x/ask/text -O - -nv -S 2>&1 | grep Error ||:)
assert_cmd "echo $a" "Error: unknown device: x" 0


a=$(wget localhost:8082/b/x/text -O - -nv -S 2>&1 | grep Error ||:)
assert_cmd "echo $a" "Error: unknown command: x" 0

a=$(wget localhost:8082/b/ask/text -O - -q ||:)
assert_cmd "echo $a" "text" 0

a=$(wget localhost:8082/SERVER/devices -O - -q ||:)
assert_cmd "echo $a" "a b" 0


a=$(wget localhost:8082/SERVER/set_log_level/3 -O - -q ||:)
assert_cmd "echo $a" "3" 0
a=$(wget localhost:8082/SERVER/get_log_level -O - -q ||:)
assert_cmd "echo $a" "3" 0
a=$(wget localhost:8082/SERVER/repeat/text -O - -q ||:)
assert_cmd "echo $a" "text" 0
a=$(wget localhost:8082/b/ask/text -O - -q ||:)
assert_cmd "echo $a" "text" 0
a=$(wget localhost:8082/SERVER/set_log_level/1 -O - -q ||:)
assert_cmd "echo $a" "1" 0


# stop the server
assert_cmd "./dev_server --stop --pidfile pid.tmp" "" 0
assert_diff test_data/log1.txt log.txt
